<% layout("/layouts/boilerplate") %>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold">
            <%= listing.title %>
          </h2>
          <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
            <div class="btn-group">
              <a href="/listings/<%=listing._id%>/edit" class="btn btn-sm btn-outline-dark">
                <i class="bi bi-pencil me-1"></i> Edit
              </a>
              <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE" class="d-inline">
                <button class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash me-1"></i> Delete
                </button>
              </form>
            </div>
            <% } %>
        </div>

        <!-- Image + Details Card -->
        <div class="card border-0 shadow rounded-4 mb-4 overflow-hidden">
          <img src="<%= listing.image.url %>" class="w-100 show-img" alt="<%= listing.title %>">
          <div class="card-body">
            <div class="mb-3 text-muted small d-flex align-items-center">
              <i class="bi bi-person-circle me-2"></i>
              Owned by <%= listing.owner.username %>
            </div>

            <p class="mb-4 fs-6 text-secondary">
              <%= listing.description %>
            </p>

            <div class="d-flex flex-wrap gap-4">
              <div class="d-flex align-items-center text-success">
                <i class="bi bi-currency-rupee me-2 fs-5"></i>
                <span class="fw-semibold fs-5">
                  <%= listing.price.toLocaleString("en-IN") %>
                </span>
                <span class="text-muted ms-1">/ night</span>
              </div>
              <div class="d-flex align-items-center text-primary">
                <i class="bi bi-geo-alt-fill me-2 fs-5"></i>
                <span class="fs-6">
                  <%= listing.location %>, <%= listing.country %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Owner Contact Info -->
        <% if (listing.contact && listing.contact.name) { %>
          <div class="card border-0 shadow-sm mb-4 rounded-4">
            <div class="card-body">
              <h5 class="mb-3 fw-bold text-primary">Owner Contact Info</h5>
              <ul class="list-unstyled">
                <li><i class="bi bi-person me-2 text-secondary"></i><strong>Name:</strong>
                  <%= listing.contact.name %>
                </li>
                <li><i class="bi bi-envelope me-2 text-secondary"></i><strong>Email:</strong>
                  <%= listing.contact.email %>
                </li>
                <li><i class="bi bi-telephone me-2 text-secondary"></i><strong>Phone:</strong>
                  <%= listing.contact.phone %>
                </li>
              </ul>
            </div>
          </div>
          <% } %>



            <!-- Review Form -->
            <% if(currUser){ %>
              <div class="card border-0 shadow-sm mb-5 rounded-4">
                <div class="card-body">
                  <h4 class="mb-4 fw-semibold">Leave a Review</h4>
                  <form method="POST" action="/listings/<%=listing._id%>/reviews" class="needs-validation" novalidate>
                    <!-- Rating -->
                    <div class="mb-3">
                      <label for="rating" class="form-label">Rating</label>
                      <fieldset class="starability-slot">
                        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked
                          aria-label="No rating." />
                        <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                        <label for="first-rate1" title="Terrible">1 star</label>
                        <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                        <label for="first-rate2" title="Not good">2 stars</label>
                        <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                        <label for="first-rate3" title="Average">3 stars</label>
                        <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                        <label for="first-rate4" title="Very good">4 stars</label>
                        <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                        <label for="first-rate5" title="Amazing">5 stars</label>
                      </fieldset>
                    </div>

                    <!-- Comment -->
                    <div class="mb-3">
                      <label for="comment" class="form-label">Comment</label>
                      <textarea name="review[comment]" id="comment" rows="3" class="form-control rounded-3"
                        required></textarea>
                      <div class="invalid-feedback">Please enter your comment</div>
                    </div>

                    <button type="submit" class="btn btn-danger px-4 py-2 fw-semibold">
                      <i class="bi bi-send me-1"></i> Submit Review
                    </button>
                  </form>
                </div>
              </div>
              <% } %>

                <!-- All Reviews -->
                <div class="mb-5">
                  <h4 class="fw-semibold mb-4">Customer Reviews</h4>
                  <% if (listing.reviews.length> 0) { %>
                    <div class="row g-4">
                      <% for (let review of listing.reviews) { %>
                        <div class="col-md-6">
                          <div class="card h-100 border-0 shadow-sm rounded-4">
                            <div class="card-body">
                              <div class="d-flex justify-content-between mb-2">
                                <h5 class="mb-0">@<%= review.author.username %>
                                </h5>
                                <small class="text-muted">
                                  <%= new Date(review.createdAt).toLocaleDateString() %>
                                </small>
                              </div>
                              <p class="starability-result mb-2" data-rating="<%= review.rating %>"></p>
                              <p class="card-text text-secondary">
                                <%= review.comment %>
                              </p>

                              <% if (currUser && (review.author._id.toString()===currUser._id.toString() ||
                                listing.owner._id.toString()===currUser._id.toString())) { %>
                                <form method="POST"
                                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                  <button class="btn btn-sm btn-outline-danger mt-2">
                                    <i class="bi bi-trash"></i> Delete
                                  </button>
                                </form>
                                <% } %>
                            </div>
                          </div>
                        </div>
                        <% } %>
                    </div>
                    <% } else { %>
                      <div class="alert alert-secondary">No reviews yet. Be the first to review!</div>
                      <% } %>
                </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    .show-img {
      height: 350px;
      object-fit: cover;
      object-position: center;
    }

    .card:hover {
      transform: translateY(-3px);
      transition: transform 0.2s ease-in-out;
    }

    .starability-slot input,
    .starability-slot label {
      cursor: pointer;
    }

    .btn-danger {
      background-color: #0d6efd;
      border: none;
    }

    .btn-danger:hover {
      background-color: #0d6efd;
      box-shadow: 0 4px 12px rgba(254, 66, 77, 0.25);
      transform: translateY(-2px);
    }
  </style>